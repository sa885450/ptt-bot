<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTT è¬èƒ½æƒ…å ±æˆ°æƒ…å®¤ v7.0 æ——è‰¦ç‰ˆ</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #121212; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #d63031; }

        body { font-family: "Microsoft JhengHei", sans-serif; background: #121212; color: #e0e0e0; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        header { border-bottom: 2px solid #d63031; padding-bottom: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.6rem; color: #fab1a0; }
        
        .status-container { display: flex; gap: 10px; align-items: center; font-size: 0.85rem; background: #000; padding: 5px 15px; border-radius: 20px; border: 1px solid #333; }
        .db-counter { color: #fab1a0; font-weight: bold; border-right: 1px solid #444; padding-right: 10px; margin-right: 5px; }

        #progress-bar-container { width: 100%; height: 3px; background: #222; margin-bottom: 20px; border-radius: 3px; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #d63031, #fab1a0); transition: width 0.1s linear; }

        #log-window { background: #000; color: #00ff00; padding: 12px; font-family: 'Consolas', monospace; font-size: 0.75rem; border-radius: 8px; height: 100px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #333; opacity: 0.9; }
        
        .control-panel { background: #1e1e1e; padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #333; display: grid; grid-template-columns: 1fr 1.5fr; gap: 30px; }
        .config-group input { background: #2d2d2d; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 6px; outline: none; margin-bottom: 10px; width: 100%; transition: 0.3s; }
        .config-group input:focus { border-color: #fab1a0; box-shadow: 0 0 5px rgba(250, 177, 160, 0.3); }
        
        .btn-update { background: #d63031; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; }
        .btn-update:hover { background: #ff7675; }
        .btn-update.success { background: #00b894; pointer-events: none; }

        #currentKeywords, #currentExcludes { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 5px; }
        .tag { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; background: #0984e3; color: #fff; transition: 0.3s; }
        .tag.board { background: #6c5ce7; margin-right: 8px; }
        .tag.heat-high { box-shadow: 0 0 8px #ff7675; border: 1px solid #ff7675; background: #d63031; }
        .tag.heat-low { opacity: 0.4; filter: grayscale(1); }
        
        .info-row { margin-bottom: 12px; line-height: 1.5; }
        .tab-wrapper { margin-bottom: 20px; border-bottom: 1px solid #333; display: flex; gap: 5px; }
        .tab-btn { background: #2d2d2d; color: #aaa; border: none; padding: 12px 30px; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .tab-btn:hover { background: #3d3d3d; color: #fff; }
        .tab-btn.active { background: #d63031; color: #fff; }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .filter-section { margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; padding: 10px 0; }
        .filter-group { display: flex; flex-wrap: wrap; gap: 8px; flex: 1; }
        .search-box { flex: 1; min-width: 200px; background: #2d2d2d; border: 1px solid #444; color: #fff; padding: 8px 15px; border-radius: 20px; outline: none; transition: 0.3s; }
        .search-box:focus { border-color: #0984e3; }
        .sort-select { background: #2d2d2d; color: #fff; border: 1px solid #444; padding: 7px 15px; border-radius: 20px; outline: none; cursor: pointer; font-size: 0.85rem; }
        .filter-btn { background: #333; color: #bbb; border: none; padding: 6px 15px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; transition: 0.2s; }
        .filter-btn:hover { background: #555; }
        .filter-btn.active { background: #6c5ce7; color: #fff; }

        .news-item { background: #1e1e1e; margin-bottom: 12px; padding: 15px; border-radius: 10px; border-left: 5px solid #0984e3; display: flex; align-items: center; border: 1px solid #222; transition: transform 0.2s, box-shadow 0.2s; }
        .news-item:hover { transform: translateX(3px); box-shadow: 0 4px 10px rgba(0,0,0,0.3); border-color: #444; }
        .news-item.burst { border-left-color: #d63031; background: #2d1a1a; }
        .news-item.history-item { border-left-color: #fdcb6e; }
        .push-count { font-weight: 900; width: 60px; text-align: center; color: #74b9ff; font-size: 1.1rem; }
        .push-count.high { color: #ff7675; text-shadow: 0 0 8px rgba(255,118,117,0.5); }
        .push-count.history-tag { color: #fdcb6e; font-size: 0.8rem; }
        .content { flex: 1; margin-left: 15px; overflow: hidden; }
        .title a { color: #ecf0f1; text-decoration: none; font-size: 1.05rem; font-weight: 500; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .title a:hover { color: #fab1a0; }
        .time-tag { color: #fab1a0; font-size: 0.85rem; margin-left: 8px; font-family: monospace; }
        .highlight { color: #ffeaa7; font-weight: bold; text-decoration: underline; }
        .meta { font-size: 0.8rem; color: #7f8c8d; margin-top: 5px; }
        
        @media (max-width: 768px) { .control-panel { grid-template-columns: 1fr; } .filter-section { flex-direction: column; align-items: stretch; } }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>ğŸ”¥ PTT è¬èƒ½æƒ…å ±æˆ°æƒ…å®¤ v7.0</h1>
        <div class="status-container">
            <span class="db-counter">ğŸ“¦ æ­·å²: <b id="dbCountHeader">0</b></span>
            <span id="status">ğŸŸ¢ ç›£æ§ä¸­</span>
        </div>
    </header>
    <div id="progress-bar-container"><div id="progress-bar"></div></div>
    <div id="log-window">> ç³»çµ±å°±ç·’ (v7.0 Core)...</div>
    
    <div class="control-panel">
        <div class="sys-info">
            <div class="info-row"><b>ğŸ¯ é—œéµå­—ï¼š</b><div id="currentKeywords"></div></div>
            <div class="info-row"><b>ğŸš« æ’é™¤å­—ï¼š</b><div id="currentExcludes"></div></div>
            <div id="boardDetails" style="margin-top:15px; border-top: 1px solid #333; padding-top: 15px; line-height: 1.8;"></div>
        </div>
        <div class="config-group">
            <input type="text" id="kwInput" placeholder="é—œéµå­— (ä»¥é€—è™Ÿåˆ†éš”)">
            <input type="text" id="exInput" placeholder="æ’é™¤å­— (ä»¥é€—è™Ÿåˆ†éš”)">
            <input type="text" id="boardsInput" placeholder="ç‰ˆå¡Š:é–€æª»:é è­¦ (ä¾‹å¦‚ Stock:99:30)">
            <button class="btn-update" id="saveBtn" onclick="updateConfig()">ğŸ’¾ å„²å­˜è¨­å®š</button>
        </div>
    </div>
    
    <div class="tab-wrapper">
        <button class="tab-btn active" id="btn-history" onclick="switchTab('history')">ğŸ“œ æ­·å²ç´€éŒ„</button>
        <button class="tab-btn" id="btn-live" onclick="switchTab('live')">ğŸ“¡ å³æ™‚ç›£æ§</button>
    </div>
    
    <div id="tab-history" class="tab-content active">
        <div class="filter-section">
            <select class="sort-select" id="historySort" onchange="renderHistory()">
                <option value="timeDesc">æ™‚é–“æœ€æ–° â†“</option>
                <option value="timeAsc">æ™‚é–“æœ€èˆŠ â†‘</option>
                <option value="pushDesc">æ¨æ–‡æœ€é«˜</option>
            </select>
            <div class="filter-group" id="historyBoardFilters"></div>
            <input type="text" class="search-box" id="historySearchInput" placeholder="ğŸ” æœå°‹æ­·å²æ¨™é¡Œ..." oninput="renderHistory()">
        </div>
        <div id="history-list"></div>
    </div>
    
    <div id="tab-live" class="tab-content">
        <div class="filter-section">
            <select class="sort-select" id="liveSort" onchange="renderPosts(true)">
                <option value="time">æœ€æ–°æŠ“å–</option>
                <option value="push">æ¨æ–‡æœ€é«˜</option>
                <option value="board">ç‰ˆå¡Šæ’åº</option>
            </select>
            <div class="filter-group" id="boardFilters"></div>
            <input type="text" class="search-box" id="searchInput" placeholder="ğŸ” æœå°‹å³æ™‚æ¨™é¡Œ..." oninput="renderPosts(true)">
        </div>
        <div id="news-container"></div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let allPosts = [], historyPosts = [], activeKeywords = [];
    let currentLiveBoard = localStorage.getItem('lastLiveBoard') || 'ALL';
    let currentHistoryBoard = localStorage.getItem('lastHistoryBoard') || 'ALL';
    let timeLeft = 15;

    setInterval(() => {
        timeLeft -= 0.1; if (timeLeft <= 0) timeLeft = 15;
        document.getElementById('progress-bar').style.width = ((15 - timeLeft) / 15) * 100 + '%';
    }, 100);

    const bullWords = ['æ¼²', 'å™´', 'åˆ©å¤š', 'å¤§è³º', 'çœ‹å¥½', 'è²·é€²', 'ç´…', 'çªç ´', 'å‰µé«˜', 'çˆ†ç™¼', 'å—æƒ ', 'ç‡Ÿæ”¶å¢', 'è²·ç›¤', 'åˆ©å¥½'];
    const bearWords = ['è·Œ', 'å´©', 'åˆ©ç©º', 'å¥—ç‰¢', 'çœ‹å£', 'è³£å‡º', 'ç¶ ', 'ç ´åº•', 'æ³•æœƒ', 'é€ƒ', 'è¡°é€€', 'ä¸‹ä¿®', 'æ‹‹å”®', 'å‡ºè²¨', 'å‰²éŸ­èœ'];

    function getSentimentTag(title) {
        let score = 0;
        bullWords.forEach(w => { if(title.includes(w)) score++; });
        bearWords.forEach(w => { if(title.includes(w)) score--; });
        if (score > 0) return `<span class="tag" style="background:#d63031; box-shadow: 0 0 5px #d63031;">ğŸ“ˆåˆ©å¤š</span>`;
        if (score < 0) return `<span class="tag" style="background:#00b894; box-shadow: 0 0 5px #00b894;">ğŸ“‰åˆ©ç©º</span>`;
        return '';
    }

    function formatTime(s) { const d = new Date(s); return isNaN(d.getTime()) ? "" : d.getHours().toString().padStart(2,'0') + ":" + d.getMinutes().toString().padStart(2,'0'); }
    function highlight(t) { 
        if (!activeKeywords || !activeKeywords.length) return t;
        let res = t;
        activeKeywords.forEach(k => { if(k && k.trim()) { const r = new RegExp(`(${k})`, 'gi'); res = res.replace(r, '<span class="highlight">$1</span>'); }}); 
        return res; 
    }
    
    function switchTab(n) { 
        document.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById(`btn-${n}`).classList.add('active');
        document.getElementById(`tab-${n}`).classList.add('active');
        if(n === 'history') loadHistory();
        localStorage.setItem('lastTab', n);
    }

    socket.on('sys_log', d => {
        const l = document.createElement('div'); l.textContent = `> [${d.time}] ${d.msg}`;
        const log = document.getElementById('log-window'); log.appendChild(l); log.scrollTop = log.scrollHeight;
    });

    socket.on('news_update', d => {
        document.getElementById('status').textContent = `ğŸŸ¢ æ›´æ–°: ${d.time}`;
        allPosts = d.posts; timeLeft = 15; 
        renderPosts(); refreshStatus();
        if(document.getElementById('tab-history').classList.contains('active')) loadHistory();
    });

    function generatePostHTML(p, isHistory = false) {
        const isBurst = p.push === 'çˆ†';
        const displayPush = isHistory ? (p.push || '<span style="font-size:0.8rem">æ­·å²</span>') : p.push;
        const pushClass = isBurst ? 'high' : (isHistory && !p.push ? 'history-tag' : '');
        const itemClass = isHistory ? 'history-item' : '';
        const boardTag = p.board ? `<span class="tag board">${p.board}</span>` : '';
        const sentimentTag = getSentimentTag(p.title);
        
        return `<div class="news-item ${itemClass} ${isBurst ? 'burst' : ''}">
            <div class="push-count ${pushClass}">${displayPush}</div>
            <div class="content">
                <div class="title"><a href="${p.link}" target="_blank">${boardTag}${sentimentTag}${highlight(p.title)} <span class="time-tag">(${formatTime(p.captured_at || p.created_at)})</span></a></div>
                <div class="meta">ä½œè€…: ${p.author || 'æœªçŸ¥'} ${isHistory ? `| å…¥åº«æ—¥æœŸ: ${new Date(p.created_at).toLocaleDateString()}` : ''}</div>
            </div>
        </div>`;
    }

    function renderPosts(save = false) {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const sortType = document.getElementById('liveSort').value;
        if (save) localStorage.setItem('lastLiveSort', sortType);
        
        let filtered = allPosts.filter(p => (currentLiveBoard === 'ALL' || p.board === currentLiveBoard) && p.title.toLowerCase().includes(searchTerm));
        if (sortType === 'push') filtered.sort((a, b) => (b.push === 'çˆ†' ? 100 : parseInt(b.push)||0) - (a.push === 'çˆ†' ? 100 : parseInt(a.push)||0));
        else if (sortType === 'board') filtered.sort((a, b) => a.board.localeCompare(b.board));
        document.getElementById('news-container').innerHTML = filtered.map(p => generatePostHTML(p, false)).join('');
    }

    async function loadHistory() { try { const res = await fetch('/api/history'); historyPosts = await res.json(); renderHistory(); } catch (e) { console.error("æ­·å²åŠ è¼‰å¤±æ•—", e); } }

    function renderHistory() {
        const searchTerm = document.getElementById('historySearchInput').value.toLowerCase();
        const sortType = document.getElementById('historySort').value;
        localStorage.setItem('lastHistorySort', sortType);
        let filtered = historyPosts.filter(p => (currentHistoryBoard === 'ALL' || p.board === currentHistoryBoard) && p.title.toLowerCase().includes(searchTerm));
        if (sortType === 'timeAsc') filtered.reverse();
        else if (sortType === 'pushDesc') filtered.sort((a, b) => (b.push === 'çˆ†' ? 100 : parseInt(b.push)||0) - (a.push === 'çˆ†' ? 100 : parseInt(a.push)||0));
        document.getElementById('history-list').innerHTML = filtered.length ? filtered.map(p => generatePostHTML(p, true)).join('') : '<div style="text-align:center; padding:50px; color:#555;">æš«ç„¡ç´€éŒ„</div>';
    }

    async function refreshStatus() {
        try {
            const res = await fetch('/api/status'); const d = await res.json();
            const histRes = await fetch('/api/history'); const histData = await histRes.json();
            if(d.dbCount !== undefined) document.getElementById('dbCountHeader').innerText = d.dbCount;
            activeKeywords = d.keywords || [];
            const counts = {}; activeKeywords.forEach(k => counts[k] = histData.filter(p => p.title.includes(k)).length);
            document.getElementById('currentKeywords').innerHTML = activeKeywords.map(k => {
                const c = counts[k] || 0; const hClass = c > 5 ? 'heat-high' : (c === 0 ? 'heat-low' : '');
                return `<span class="tag ${hClass}" title="æ­·å²å‘½ä¸­: ${c}æ¬¡">${k}</span>`;
            }).join('');
            document.getElementById('currentExcludes').innerHTML = (d.excludes || []).map(e => `<span class="tag" style="background:#555">${e}</span>`).join('');
            const b = d.boards || [];
            document.getElementById('boardDetails').innerHTML = b.map(x => {
                const name = typeof x === 'object' ? x.name : x;
                return `<span>â€¢ <b>${name}</b> (ğŸ””${typeof x === 'object' ? x.limit : 99} / ğŸ”¥+${typeof x === 'object' ? x.trend : 30})</span>`;
            }).join('<br>');
            const buildFilters = (currentVal, onClickName) => `<button class="filter-btn ${currentVal==='ALL'?'active':''}" onclick="${onClickName}('ALL')">å…¨éƒ¨</button>` + b.map(x => { const name = typeof x === 'object' ? x.name : x; return `<button class="filter-btn ${currentVal===name?'active':''}" onclick="${onClickName}('${name}')">${name}</button>`; }).join('');
            document.getElementById('boardFilters').innerHTML = buildFilters(currentLiveBoard, 'setLiveBoardFilter');
            document.getElementById('historyBoardFilters').innerHTML = buildFilters(currentHistoryBoard, 'setHistoryBoardFilter');
            if (!document.getElementById('kwInput').value) document.getElementById('kwInput').value = activeKeywords.join(', ');
            if (!document.getElementById('exInput').value) document.getElementById('exInput').value = (d.excludes || []).join(', ');
            if (!document.getElementById('boardsInput').value) document.getElementById('boardsInput').value = b.map(x => typeof x === 'object' ? `${x.name}:${x.limit}:${x.trend}` : `${x}:99:30`).join(', ');
        } catch (e) { console.error("ç‹€æ…‹æ›´æ–°å¤±æ•—", e); }
    }
    function setLiveBoardFilter(b) { currentLiveBoard = b; localStorage.setItem('lastLiveBoard', b); renderPosts(); refreshStatus(); }
    function setHistoryBoardFilter(b) { currentHistoryBoard = b; localStorage.setItem('lastHistoryBoard', b); renderHistory(); refreshStatus(); }
    
    async function updateConfig() {
        const btn = document.getElementById('saveBtn');
        const keywords = document.getElementById('kwInput').value.split(',').map(s => s.trim()).filter(s => s);
        const excludes = document.getElementById('exInput').value.split(',').map(s => s.trim()).filter(s => s);
        const bRaw = document.getElementById('boardsInput').value.split(',').map(s => s.trim()).filter(s => s);
        const boards = bRaw.map(s => { const p = s.split(':'); return { name: p[0], limit: parseInt(p[1])||99, trend: parseInt(p[2])||30 }; });
        await fetch('/api/config', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({keywords, excludes, boards}) });
        btn.innerText = 'âœ… å„²å­˜æˆåŠŸ'; btn.classList.add('success');
        setTimeout(() => { btn.innerText = 'ğŸ’¾ å„²å­˜è¨­å®š'; btn.classList.remove('success'); }, 2000);
        refreshStatus();
    }
    
    window.onload = () => { 
        if (localStorage.getItem('lastLiveSort')) document.getElementById('liveSort').value = localStorage.getItem('lastLiveSort');
        if (localStorage.getItem('lastHistorySort')) document.getElementById('historySort').value = localStorage.getItem('lastHistorySort');
        switchTab(localStorage.getItem('lastTab') || 'history'); refreshStatus(); 
    };
</script>
</body>
</html>